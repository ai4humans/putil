# shippable.yml
# Copyright (c) 2013-2015 Pablo Acosta-Serafini
# See LICENSE for details

language: python

# For getting data off build
# archive: true

build_image: shippableimages/ubuntu1404_python

python:
  - 2.7

# Install Matplotlib pre-requisites that do not get pip-installed
before_install:
  - shippable_retry apt-get update
  - shippable_retry apt-get install -y libfreetype6-dev
  - if [ ! -f /usr/include/ft2build.h ]; then ln -s /usr/include/freetype2/ft2build.h /usr/include/.; fi
  - shippable_retry apt-get install -y liblapack-dev
  - shippable_retry apt-get install -y libpng12-dev
  - shippable_retry apt-get install -y python-dev
  - shippable_retry apt-get install -y gfortran

install:
  - pip install -r requirements.txt --use-mirrors

before_script:
  # Make folders for the reports
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  # Report version numbers for all dependencies
  - pip freeze
  - dpkg --status libfreetype6-dev
  - dpkg --status liblapack-dev
  - dpkg --status libpng12-dev
  - dpkg --status python-dev
  - dpkg --status gfortran

#  - PYTHON_SITE_PACKAGES=/root/ve/lib/python${VIRTUALENV_PYTHON}/site-packages/
script:
  # Install package
  - python setup.py sdist
  - PKG_VERSION=$(grep __version__ $SHIPPABLE_REPO_DIR/putil/__init__.py | sed -e "s/.*__version__ = '\(.*\)'/\1/g")
  - pip install dist/putil-${PKG_VERSION}.tar.gz
  # Get images off build:
  # - mkdir -p shippable/images
  # - ./sbin/gen_ref_images.py shippable/images
  # Find where build installs Python packages
  - PYTHON_SITE_PACKAGES=$($SHIPPABLE_REPO_DIR/sbin/get-site-packages-dir.py ${VIRTUALENV_PYTHON})
  - echo "PYTHON_SITE_PACKAGES=${PYTHON_SITE_PACKAGES}"
  - ls ${PYTHON_SITE_PACKAGES}/putil/
  # Write coverage configuration file
  - ./sbin/coveragerc-manager.py 'shippable' 1 $PYTHON_SITE_PACKAGES
  - cat $SHIPPABLE_REPO_DIR/.coveragerc_shippable
  - rm -rf tox.ini
  # Run the tests
  - py.test -s -vv --junitxml=shippable/testresults/pytest.xml
  - py.test -x --cov-config $SHIPPABLE_REPO_DIR/.coveragerc_shippable --cov ${PYTHON_SITE_PACKAGES}/putil/ --cov-report xml

notifications:


  on_success: change
  on_failure: always
